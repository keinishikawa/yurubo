# Feature Specification: つながり管理（Connections）

**Feature Branch**: `000-connections`
**Created**: 2025-12-03
**Status**: Draft
**Input**: User description: "Epic 000: つながり管理（Connections）- ユーザー間の関係性をアクティビティ単位で管理し、イベント配信範囲を適切に制御する基盤機能"

## 概要

ユーザー間の関係性を「アクティビティ単位」で管理し、イベント配信範囲を適切に制御する基盤機能。

## Clarifications

### Session 2025-12-03

- Q: ブロック機能の動作はどうするか？ → A: ブロック機能は実装しない（スコープ外）
- Q: つながり削除後の再リクエストは可能か？ → A: 削除後も再リクエスト可能（相手が承認すれば再度つながれる）
- Q: ユーザー検索の公開範囲は？ → A: 全ユーザーが検索可能（プライバシー設定は将来対応）
- Q: つながり成立時の通知は？ → A: 承認時、送信者に通知する
- Q: 同時リクエストの処理は？ → A: 自動的につながり成立（両者の意思確認済みとみなす）

**ユーザー価値**:
- 「この人とは飲みOK、でも旅行はNG」といった柔軟な関係設定
- 興味のないカテゴリのイベント通知を受けない
- プライバシーとつながりのバランスを自分でコントロール

## User Scenarios & Testing *(mandatory)*

### User Story 1 - つながりの追加 (Priority: P1)

ユーザーが友人を「つながり」として追加し、その人とイベントで繋がれるようになる基本フロー。

**Why this priority**: つながり機能の最も基本となる操作であり、他のすべての機能の前提となる。つながりがなければカテゴリ設定もイベント配信もできない。

**Independent Test**: ユーザーが友人を検索し、つながりリクエストを送信して承認されるまでの一連の流れをテストできる。つながりリストに相手が表示されることで価値を確認可能。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザー, **When** 友人のユーザー名またはIDで検索, **Then** 該当するユーザーが検索結果に表示される
2. **Given** 検索結果から相手を選択, **When** つながりリクエストを送信, **Then** 相手にリクエスト通知が届き、自分のリクエスト一覧に「pending」状態で表示される
3. **Given** リクエスト受信者がリクエスト一覧を確認, **When** 承認ボタンを押す, **Then** 双方のつながりリストにお互いが表示される
4. **Given** 既につながりがある相手, **When** つながりリクエストを送信しようとする, **Then** エラーメッセージが表示され送信できない

---

### User Story 2 - つながりリクエストの承認・拒否 (Priority: P1)

ユーザーが受け取ったつながりリクエストを承認または拒否し、望まない相手とつながらずに済む。

**Why this priority**: つながり成立の必須フローであり、US1と一体で機能する。ユーザーが自分でつながり相手を選べることでプライバシーを守る。

**Independent Test**: 受信したリクエストの一覧表示、承認・拒否操作、期限切れ処理をテスト可能。

**Acceptance Scenarios**:

1. **Given** 未処理のつながりリクエストがある, **When** リクエスト一覧ページを開く, **Then** 送信者名とリクエスト日時が表示される
2. **Given** リクエスト一覧でリクエストを確認, **When** 承認ボタンを押す, **Then** つながりが成立し、リクエスト一覧から消える
3. **Given** リクエスト一覧でリクエストを確認, **When** 拒否ボタンを押す, **Then** リクエストが削除され（相手への通知なし）、一覧から消える
4. **Given** 7日間未処理のリクエスト, **When** 期限が切れる, **Then** リクエストが自動的に削除される

---

### User Story 3 - アクティビティ単位の関係設定 (Priority: P2)

ユーザーがつながりごとにカテゴリ（飲み・旅行・スポーツ等）を設定し、特定のアクティビティだけ一緒に参加できる関係を作る。

**Why this priority**: つながり機能の差別化ポイント。基本的なつながり成立（US1/US2）の後に必要となる付加価値機能。

**Independent Test**: つながり編集画面でカテゴリを設定し、保存後に設定が反映されていることをテスト可能。

**Acceptance Scenarios**:

1. **Given** つながりリストに相手がいる, **When** 編集ボタンを押す, **Then** カテゴリチェックボックス（飲み・旅行・スポーツ等）が表示される
2. **Given** カテゴリ編集画面, **When** カテゴリを選択して保存, **Then** 設定が保存され、次回表示時も反映されている
3. **Given** 新規つながり成立直後, **When** つながりリストを確認, **Then** 全カテゴリがOFF状態（デフォルト）で表示される
4. **Given** AさんがBさんを「飲み」OKに設定, **When** Bさんのイベント配信設定を確認, **Then** Bさん側でAさんを「飲み」OKにしていない場合、AさんにはBさんの飲みイベントは配信されない（双方向チェック）

---

### User Story 4 - つながりリストの閲覧・管理 (Priority: P2)

ユーザーが自分のつながりリストを一覧で確認し、誰とどのアクティビティで繋がっているか把握できる。

**Why this priority**: 既存のつながりを確認・管理するための基本UI。US1/US2の後に必要。

**Independent Test**: つながり一覧ページの表示、フィルタ機能、検索機能、削除機能をテスト可能。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザー, **When** つながりページ（/connections）を開く, **Then** 自分のつながりリストが表示される
2. **Given** つながりリストが表示されている, **When** カテゴリフィルタ（例：「飲み友達のみ」）を選択, **Then** 該当カテゴリがONのつながりのみ表示される
3. **Given** つながりリストが表示されている, **When** 名前で検索, **Then** 検索条件に一致するつながりのみ表示される
4. **Given** つながりリストで相手を選択, **When** 削除ボタンを押して確認, **Then** つながりが削除され、リストから消える

---

### User Story 5 - イベント配信フィルタリング (Priority: P3)

システムがイベント投稿時に該当カテゴリがOKなつながりのみに配信し、ユーザーが関係ないイベントを見なくて済む。

**Why this priority**: Epic 001（イベント作成）との連携機能。つながり管理の最終目的だが、イベント機能がないと単体では価値を発揮できない。

**Independent Test**: イベント投稿後、カテゴリ設定に応じて適切な相手にのみ配信されることをテスト可能（Epic 001実装後）。

**Acceptance Scenarios**:

1. **Given** ユーザーAとBがつながり（飲みOK、旅行NG）, **When** ユーザーAが飲みイベントを投稿, **Then** ユーザーBのタイムラインに表示される
2. **Given** ユーザーAとBがつながり（飲みOK、旅行NG）, **When** ユーザーAが旅行イベントを投稿, **Then** ユーザーBのタイムラインに表示されない
3. **Given** ユーザーAがBを飲みOK、BがAを飲みNG, **When** ユーザーAが飲みイベントを投稿, **Then** ユーザーBのタイムラインに表示されない（双方向チェック）
4. **Given** ユーザーにつながりがない状態, **When** イベントを投稿, **Then** 誰にも配信されない（または自分のみに表示）

---

### Edge Cases

- **自分自身へのリクエスト**: 自分自身にはつながりリクエストを送信できない
- **重複リクエスト**: 既にpending状態のリクエストがある相手には再送信できない
- **同時リクエスト**: AからBへ、BからAへ同時にリクエストした場合、自動的につながり成立（両者の意思確認済みとみなす）
- **削除したユーザー**: 相手がアカウントを削除した場合、つながりも自動的に解除される
- **つながり上限**: つながり数の上限に達した場合、新規リクエストを送信できない（上限値は設定次第）
- **カテゴリ未設定**: 全カテゴリOFFの場合、どのイベントも配信されない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはユーザー名またはIDによる友人検索機能を提供しなければならない。全ユーザーが検索対象となる
- **FR-002**: システムはつながりリクエストの送信機能を提供しなければならない
- **FR-003**: システムはつながりリクエストの承認・拒否機能を提供しなければならない
- **FR-004**: システムは未処理リクエストを7日後に自動的に期限切れにしなければならない
- **FR-005**: システムはつながりリストの一覧表示機能を提供しなければならない
- **FR-006**: システムはつながりごとのカテゴリ設定機能を提供しなければならない
- **FR-007**: カテゴリ設定は双方向で管理され、両者がOKの場合のみイベント配信対象となる
- **FR-008**: 新規つながり成立時、全カテゴリはデフォルトでOFF状態となる
- **FR-009**: システムはつながり削除機能を提供しなければならない。削除後も同じ相手への再リクエストは可能
- **FR-010**: システムはカテゴリ別のフィルタ機能を提供しなければならない
- **FR-011**: システムは名前・カテゴリによる検索機能を提供しなければならない
- **FR-012**: つながりリクエスト拒否時、送信者への通知は行わない
- **FR-015**: つながりリクエスト承認時、送信者に通知する
- **FR-013**: ユーザーは自分のつながり情報のみ閲覧・編集できる（プライバシー保護）
- **FR-014**: イベント投稿時、該当カテゴリがOKなつながりのみに配信される

### Key Entities

- **つながり（Connection）**: 2人のユーザー間の関係性を表す。各つながりにはカテゴリごとのOK/NG設定があり、ステータス（pending/active）を持つ。ブロック機能はスコープ外
- **つながりリクエスト（Connection Request）**: つながり成立前の申請状態。送信者、受信者、任意のメッセージ、有効期限を持つ
- **アクティビティカテゴリ**: 飲み・旅行・スポーツなど、イベントの種類を分類するタグ。つながりごとにON/OFF設定可能
- **ユーザー**: つながりの主体。ユーザー名とIDで識別可能

### Assumptions

- アクティビティカテゴリは「飲み」「旅行」「スポーツ」の3種類を初期提供（将来的に拡張可能な設計）
- つながり数の上限は初期段階では設けない（パフォーマンス監視の上で必要に応じて設定）
- つながり削除は論理削除（ソフトデリート）で実装し、データ復旧の可能性を残す
- リクエストメッセージは任意入力（空でも送信可能）
- 通知方法はアプリ内通知を基本とする（将来的にメール・プッシュ通知を追加可能）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは2分以内につながりリクエストの送信を完了できる
- **SC-002**: ユーザーは30秒以内につながりリクエストの承認・拒否を完了できる
- **SC-003**: つながりリスト表示は1秒以内に完了する（100件以下の場合）
- **SC-004**: カテゴリ設定の変更は即座に反映され、次回イベント配信から適用される
- **SC-005**: 90%以上のユーザーが初回利用時につながり追加を成功できる
- **SC-006**: つながりリクエストの承認率が70%以上を維持する
- **SC-007**: カテゴリ設定機能の利用率が50%以上（つながり成立後1週間以内）
