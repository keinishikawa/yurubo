# Feature Specification: フェーズ 1：イベント作成機能

**Feature Branch**: `001-event-creation`
**Created**: 2025-11-11
**Status**: Draft
**Input**: User description: "フェーズ 1：イベント作成機能 - 匿名投稿によるイベント作成とタイムライン表示"

## Clarifications

### Session 2025-11-11

- Q: つながりリストの初期状態 → A: 自分が有効にしているカテゴリについてデフォルトオンにし、初回繋がり時に必要に応じてオフさせる
- Q: 匿名 ID 生成ルール → A: 有名な映画の登場人物を参考に生成する
- Q: タイムライン無限スクロールのページサイズ → A: 20 件
- Q: 価格帯の入力形式 → A: 範囲入力（スライダーで自動入力、デフォルト 3000~5000）
- Q: 投稿削除機能の有無 → A: イベント中止ボタンを幹事側に実装（タイムラインからは消える）

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 匿名イベント投稿（つながりリスト配信） (Priority: P1)

ユーザーが心理的抵抗なく「軽く誘う」ためのイベント投稿を行う。投稿は「つながりリスト」内のアクティビティ該当者のみに配信され、投稿者は自動的に仮幹事となる。

**Why this priority**: YURUBO の核心価値「誘う摩擦をゼロにする」を実現する最優先機能。つながりリストによるマッチ範囲制御が匿名性と安全性を両立する。

**Independent Test**: ログイン後、投稿モーダルから基本情報を入力し、投稿完了後にタイムラインに匿名投稿として表示され、つながりリスト内の該当カテゴリ OK ユーザーのみに配信されることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがログインしている, **When** ホーム画面右下の「＋投稿」ボタンをタップする, **Then** イベント投稿モーダルが表示される
2. **Given** 投稿モーダルが開いている, **When** カテゴリ「飲み」、開催日時「2025-11-15 19:00〜22:00」、想定人数「3〜5 人」、価格帯「3000 円」、コメント「軽く飲みたい」を入力して投稿ボタンを押す, **Then** モーダルが閉じ、タイムラインに匿名投稿として即時反映される
3. **Given** イベント投稿が完了した, **When** タイムラインを確認する, **Then** 投稿者の名前は表示されず、匿名 ID（例：🍶A）で表示される
4. **Given** イベント投稿が完了した, **When** つながりリストで該当カテゴリ（飲み）が OK のユーザーのタイムラインを確認する, **Then** 投稿が表示される
5. **Given** イベント投稿が完了した, **When** つながりリストで該当カテゴリ（飲み）が NG のユーザーのタイムラインを確認する, **Then** 投稿は表示されない
6. **Given** ユーザーが同カテゴリで 1 日に 3 件投稿済み, **When** 同カテゴリで 4 件目の投稿を試みる, **Then** エラーメッセージ「1 日の投稿上限（3 件）に達しました」が表示され、投稿されない
7. **Given** 投稿モーダルで必須項目（カテゴリ、開催日時）が未入力, **When** 投稿ボタンを押す, **Then** エラーメッセージ「カテゴリと開催日時は必須です」が表示され、投稿されない

---

### User Story 2 - タイムライン閲覧（つながりベース） (Priority: P2)

ユーザーが自分の「つながりリスト」内で該当アクティビティ OK のイベント投稿をタイムラインで閲覧し、参加したいイベントを探す。

**Why this priority**: 投稿されたイベントの発見手段として必要。P1 の投稿機能と組み合わせて初めて価値が生まれる。つながりリストベースのフィルタリングにより安全な閲覧環境を提供。

**Independent Test**: タイムラインに複数のイベント投稿が表示され、各投稿のカテゴリ、日時、人数、価格帯、コメントが閲覧可能で、自分のつながりリスト内の該当カテゴリ OK 投稿のみが表示されることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 複数のイベント投稿が存在し、ユーザーのつながりリストで該当カテゴリ OK のものがある, **When** ホーム画面（タイムライン）を開く, **Then** 該当投稿のみが新しい順に一覧表示される
2. **Given** タイムラインにイベント投稿が表示されている, **When** 投稿カードを確認する, **Then** カテゴリアイコン、開催日時、想定人数、価格帯、コメント、匿名 ID が表示される
3. **Given** タイムラインにイベント投稿が表示されている, **When** 投稿カードを確認する, **Then** 投稿者の実名は表示されず、匿名化されている
4. **Given** タイムラインに 10 件以上の投稿がある, **When** 画面を下方向にスクロールする, **Then** 追加の投稿が順次読み込まれる（無限スクロール）
5. **Given** タイムラインに投稿が 0 件, **When** ホーム画面を開く, **Then** 「まだイベントが投稿されていません。右下の＋ボタンから最初のイベントを作成しましょう！」というガイドメッセージが表示される

---

### User Story 3 - イベント情報編集（投稿者のみ・参加者確定前） (Priority: P3)

投稿者（仮幹事）が投稿後にイベント情報を編集できる。ただし、参加者が承認される前のみ編集可能。

**Why this priority**: 投稿後の情報修正ニーズに対応。ただし、MVP（P1+P2）だけでも基本的な価値提供は可能なため、P3 とする。

**Independent Test**: 自分が投稿したイベントの編集画面から情報を変更し、タイムラインとマイイベントに反映されることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーが自分の投稿したイベント（参加者未承認）を選択している, **When** マイイベント画面でイベントカードをタップし「編集」ボタンを押す, **Then** 投稿モーダルと同じ UI で編集画面が開き、既存情報が入力済み状態で表示される
2. **Given** イベント編集画面が開いている, **When** 開催日時を「2025-11-16 20:00〜23:00」に変更して保存する, **Then** タイムラインとマイイベントに変更が即座に反映される
3. **Given** 参加者が既に承認されたイベント, **When** 編集画面を開こうとする, **Then** 「参加者確定後は編集できません」という警告メッセージが表示され、編集不可状態となる
4. **Given** 他のユーザーが投稿したイベント, **When** タイムラインやマイイベントで確認する, **Then** 編集ボタンは表示されない

---

### Edge Cases

- **開催日時（開始）が過去の場合**: 投稿時にバリデーションエラー「開催日時は現在より未来の日時を指定してください」を表示
- **開催日時（終了）が開始より前の場合**: 投稿時にバリデーションエラー「終了時刻は開始時刻より後に設定してください」を表示
- **想定人数の最小値が最大値より大きい場合**: 投稿時にバリデーションエラー「最小人数は最大人数以下である必要があります」を表示
- **ネットワークエラーで投稿失敗**: 「投稿に失敗しました。ネットワーク接続を確認して再試行してください」というエラーメッセージを表示し、入力内容は保持
- **同時に複数ユーザーが投稿**: タイムラインはリアルタイム更新され、すべての投稿が時系列順に表示される
- **受付締切日時が開催日時（開始）より後**: 投稿時にバリデーションエラー「受付締切は開催開始時刻より前に設定してください」を表示
- **つながりリストが空のユーザー**: 投稿は可能だが、配信先が 0 件となり、警告メッセージ「つながりリストが設定されていません。設定画面から追加してください」を表示
- **投稿主本人のタイムライン**: 自分の投稿も他の投稿と同様に匿名 ID で表示される（一貫性のため）
- **イベント中止**: 幹事がイベント中止ボタンを押すと、タイムラインから即座に非表示となり、参加者全員に中止通知が送信される

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムはユーザーがイベント投稿モーダルを開けるようにしなければならない（ホーム画面右下の「＋投稿」ボタン）
- **FR-002**: システムはイベント投稿時に以下の情報を入力できるようにしなければならない：カテゴリ（必須）、開催日時（開始・終了、必須）、受付締切日時（任意）、想定人数（必須）、価格帯（スライダー範囲入力、デフォルト 3000~5000 円、任意）、コメント（任意）
- **FR-003**: システムはカテゴリとして「飲み」「旅行」「テニス」「その他」を選択肢として提供しなければならない
- **FR-004**: システムは想定人数を「最小人数」〜「最大人数」の範囲形式で入力できるようにしなければならない（例：2〜6 人）
- **FR-005**: システムは投稿者の実名を隠し、イベントカテゴリ別の匿名 ID（飲み 🍶A、旅行 ✈️A、テニス 🎾A 等）で表示しなければならない
- **FR-006**: システムは投稿完了後、即座にタイムラインに反映しなければならない
- **FR-007**: システムは投稿者を自動的に「仮幹事」として登録しなければならない
- **FR-008**: システムは投稿をユーザーの「つながりリスト」内で該当カテゴリが OK のユーザーのみに配信しなければならない
- **FR-009**: システムは同一カテゴリの投稿を 1 日 3 件までに制限しなければならない
- **FR-010**: システムはタイムラインにイベント投稿を新しい順（投稿日時降順）で一覧表示しなければならない
- **FR-011**: システムは各イベント投稿カードに以下の情報を表示しなければならない：カテゴリアイコン、開催日時、想定人数、価格帯、コメント、匿名 ID
- **FR-012**: システムはタイムラインで無限スクロールをサポートし、スクロール時に追加の投稿を 20 件ずつ読み込まなければならない
- **FR-013**: システムは投稿者が自分のイベントを編集できるようにしなければならない（参加者承認前のみ）
- **FR-014**: システムは参加者が承認された後はイベント編集を禁止しなければならない
- **FR-020**: システムは幹事がイベント中止ボタンでイベントをキャンセルできるようにしなければならない（タイムラインから非表示、参加者には通知）
- **FR-015**: システムは以下のバリデーションを実施しなければならない：
  - カテゴリと開催日時（開始・終了）は必須
  - 開催日時（開始）は現在より未来
  - 開催日時（終了）は開始より後
  - 想定人数の最小値 ≤ 最大値
  - 受付締切日時 < 開催日時（開始）（入力時のみ）
  - 同一カテゴリの投稿は 1 日 3 件まで
- **FR-016**: システムはバリデーションエラー時に日本語の明確なエラーメッセージを表示しなければならない
- **FR-017**: システムはネットワークエラー時にユーザーフレンドリーなエラーメッセージを表示し、入力内容を保持しなければならない
- **FR-018**: システムは投稿が 0 件の場合、ガイドメッセージを表示しなければならない
- **FR-019**: システムはつながりリストが空の場合、警告メッセージを表示しなければならない

### Key Entities

- **Event（イベント）**: ユーザーが作成する社交イベント。カテゴリ、タイトル（自動生成可）、開催日時（開始・終了）、受付締切日時、想定人数（最小・最大）、価格帯、コメント、投稿者 ID、ステータス（募集中/承認済/開催済/終了）、作成日時を持つ
- **User（ユーザー）**: イベントを投稿または参加するユーザー。名前、プロフィール、通知設定、送金情報を持つ。イベント内ではカテゴリ別匿名 ID（飲み 🍶A、旅行 ✈️A、テニス 🎾A 等）で表示される
- **Connection（つながり）**: ユーザー間の関係設定。user_id、target_id、category_flags（JSONB 形式でアクティビティ単位の許可設定）を持つ。例：「A さんとは飲み OK・旅行 NG」。初期状態では、ユーザー自身が有効にしているカテゴリについてデフォルト ON（つながり追加時に個別に OFF 設定可能）
- **Category（カテゴリ）**: イベントの種類。飲み、旅行、テニス、その他などの選択肢

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: ユーザーはイベント投稿を 30 秒以内に完了できる
- **SC-002**: 投稿されたイベントはタイムラインに 1 秒以内に反映される
- **SC-003**: タイムラインは 50 件のイベント投稿を遅延なく表示できる
- **SC-004**: 90%のユーザーが初回イベント投稿を一度で成功できる（バリデーションエラーなし）
- **SC-005**: 匿名化により、投稿者の実名がタイムライン上で一切表示されない（100%匿名化達成）
- **SC-006**: つながりリストベースの配信により、ユーザーが「知らない人からの誘い」を受けることがゼロになる（100%安全性達成）
- **SC-007**: イベント編集は既存情報が正しくプリセットされた状態で開き、5 秒以内に編集を開始できる
