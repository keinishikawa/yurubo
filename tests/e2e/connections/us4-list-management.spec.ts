/**
 * ファイル名: us4-list-management.spec.ts
 *
 * 【概要】
 * User Story 4（つながりリストの閲覧・管理）のE2Eテスト
 * spec.mdの受入シナリオをテストケース化
 *
 * 【テスト対象】
 * - つながりリスト一覧表示
 * - カテゴリフィルタ機能
 * - 名前検索機能
 * - つながり削除機能
 *
 * 【依存関係】
 * - Playwright: E2Eテストフレームワーク
 * - spec.md: User Story 4の受入シナリオ定義
 */

import { test, expect } from '@playwright/test'
import { signIn } from '../helpers/auth'

/**
 * テストスイート: User Story 4 - つながりリストの閲覧・管理
 *
 * 【設計根拠】spec.md User Story 4の受入シナリオ
 */
test.describe('User Story 4: つながりリストの閲覧・管理', () => {
  /**
   * ブラウザコンソールログとエラーをキャプチャ（デバッグ用）
   */
  test.beforeEach(async ({ page }) => {
    // ブラウザコンソールログをキャプチャ
    page.on('console', (msg) => {
      console.log(`[BROWSER ${msg.type().toUpperCase()}] ${msg.text()}`)
    })

    // ページエラーをキャプチャ
    page.on('pageerror', (err) => {
      console.error(`[PAGE ERROR] ${err.message}`)
    })

    // ネットワークレスポンスエラーをキャプチャ
    page.on('response', (response) => {
      if (!response.ok() && response.url().includes('/api/')) {
        console.error(`[API ERROR] ${response.status()} ${response.url()}`)
      }
    })
  })

  /**
   * T032-1: つながりリスト一覧ページが表示される
   *
   * Given: ログイン済みユーザー
   * When: /connections ページにアクセス
   * Then: つながりリストページが表示される
   */
  test('T032-1: つながりリストページが表示される', async ({ page }) => {
    // Given: ログイン済み状態を作成
    await signIn(page, 'テストユーザーUS4-1')

    // When: つながりリストページにアクセス
    await page.goto('/connections')

    // Then: ページが表示される
    await expect(page.locator('h1:has-text("つながりリスト")')).toBeVisible({ timeout: 10000 })
  })

  /**
   * T032-2: つながりがない場合、空状態メッセージが表示される
   *
   * Given: ログイン済みユーザーでつながりが0件
   * When: /connections ページにアクセス
   * Then: 「つながりがありません」メッセージが表示される
   */
  test('T032-2: つながりがない場合、空状態メッセージが表示される', async ({ page }) => {
    // Given: 新規ユーザーでログイン（つながり0件）
    await signIn(page, '新規ユーザーUS4-2')

    // When: つながりリストページにアクセス
    await page.goto('/connections')

    // Then: 空状態メッセージが表示される
    await expect(page.locator('text=つながりがありません')).toBeVisible({ timeout: 10000 })
  })

  /**
   * T032-3: カテゴリフィルタ - 全カテゴリ表示
   *
   * Given: つながりリストページが表示されている
   * When: カテゴリフィルタが「すべて」の場合
   * Then: すべてのつながりが表示される
   *
   * Note: つながりを作成するためのデータベースシードが必要なため、
   * 実際の実装ではテストヘルパー関数でデータを準備する必要があります。
   */
  test.skip('T032-3: カテゴリフィルタ「すべて」で全つながりが表示される', async () => {
    // TODO: テストヘルパーでつながりを作成
    // 1. ユーザーA作成
    // 2. ユーザーB, C作成
    // 3. A→B（飲みOK）、A→C（旅行OK）のつながりを作成
    // 4. つながりリストページでフィルタ「すべて」を確認
    // 5. B, C両方が表示されることを確認
  })

  /**
   * T032-4: カテゴリフィルタ - 特定カテゴリのみ表示
   *
   * Given: つながりリストページが表示されている
   * When: カテゴリフィルタで「飲み」を選択
   * Then: 飲みカテゴリがOKのつながりのみ表示される
   *
   * Note: つながりを作成するためのデータベースシードが必要
   */
  test.skip('T032-4: カテゴリフィルタで「飲み」を選択すると、飲みOKのつながりのみ表示される', async () => {
    // TODO: テストヘルパーでつながりを作成
  })

  /**
   * T032-5: 名前検索機能
   *
   * Given: つながりリストページが表示されている
   * When: 検索ボックスに名前を入力
   * Then: 該当する名前のつながりのみ表示される
   *
   * Note: つながりを作成するためのデータベースシードが必要
   */
  test.skip('T032-5: 検索ボックスに名前を入力すると、該当するつながりのみ表示される', async () => {
    // TODO: テストヘルパーでつながりを作成
  })

  /**
   * T032-6: つながり削除 - 確認ダイアログが表示される
   *
   * Given: つながりが存在する状態
   * When: 削除ボタンをクリック
   * Then: 削除確認ダイアログが表示される
   *
   * Note: つながりを作成するためのデータベースシードが必要
   */
  test.skip('T032-6: 削除ボタンクリックで確認ダイアログが表示される', async () => {
    // TODO: テストヘルパーでつながりを作成
    // 1. ユーザーA作成
    // 2. ユーザーB作成
    // 3. A→Bのつながりを作成
    // 4. Aでログイン
    // 5. つながりリストページでBの削除ボタンをクリック
    // 6. 確認ダイアログが表示されることを確認
  })

  /**
   * T032-7: つながり削除 - 確認後に削除される
   *
   * Given: 削除確認ダイアログが表示されている
   * When: 「削除」ボタンをクリック
   * Then: つながりが削除され、リストから消える
   *
   * Note: つながりを作成するためのデータベースシードが必要
   */
  test.skip('T032-7: 確認ダイアログで削除を選択すると、つながりが削除される', async () => {
    // TODO: テストヘルパーでつながりを作成
  })

  /**
   * T032-8: つながり削除 - キャンセルで削除されない
   *
   * Given: 削除確認ダイアログが表示されている
   * When: 「キャンセル」ボタンをクリック
   * Then: ダイアログが閉じ、つながりは削除されない
   *
   * Note: つながりを作成するためのデータベースシードが必要
   */
  test.skip('T032-8: 確認ダイアログでキャンセルを選択すると、つながりは削除されない', async () => {
    // TODO: テストヘルパーでつながりを作成
  })
})
